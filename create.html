<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Keepsy</title>
    <link rel="stylesheet" href="create.css">
</head>

<body>

    <!-- SCREEN 1: START -->
    <section id="screen-start" class="screen active">
        <div class="screen-content">
            <h1 class="title">Start your Keepsy</h1>
            <p class="subtitle">A few details to begin.</p>

            <form id="start-form">
                <div class="form-group">
                    <label for="your-name">Your name</label>
                    <input type="text" id="your-name" placeholder="Name (optional)" autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="partner-name">Partner's name</label>
                    <input type="text" id="partner-name" placeholder="Partner's name (optional)" autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="start-date">Date you got together ❤️</label>
                    <input type="date" id="start-date" required>
                </div>

                <button type="submit" class="btn-primary">Continue</button>
                <p class="micro-copy">This helps us count your days together.</p>
                <p class="trust-copy">Nothing is shared until you invite your partner.</p>
            </form>
        </div>
    </section>

    <!-- SCREEN 2: FIRST MEMORY -->
    <section id="screen-memory" class="screen">
        <div class="screen-content">
            <h1 class="title">Your first memory</h1>
            <p class="subtitle">It can be anything.</p>

            <form id="memory-form">
                <div class="form-group">
                    <label for="memory-photo" class="file-label">
                        <span id="file-text">Upload photo</span>
                        <input type="file" id="memory-photo" accept="image/*" required>
                    </label>
                    <div id="image-preview" class="hidden"></div>
                </div>

                <div class="form-group">
                    <label for="memory-date">Date</label>
                    <input type="date" id="memory-date" required>
                </div>

                <div class="form-group">
                    <label for="memory-note">Note</label>
                    <textarea id="memory-note" rows="3" placeholder="What made this day special?"></textarea>
                </div>

                <button type="submit" class="btn-primary">Save memory</button>
            </form>
        </div>
    </section>

    <!-- SCREEN 3: TIMELINE -->
    <section id="screen-timeline" class="screen">
        <div class="timeline-header">
            <img src="logo.png" alt="Keepsy" class="mini-logo">
            <div class="days-counter">❤️ <span id="days-count">0</span> days together</div>
        </div>

        <div class="timeline-feed">
            <article class="memory-card">
                <img id="display-photo" src="" alt="First memory" class="memory-img">
                <div class="memory-meta">
                    <span id="display-date" class="memory-date"></span>
                </div>
                <p id="display-note" class="memory-note"></p>
            </article>

            <p class="timeline-footer-text">This is the beginning.</p>

            <div class="action-buttons">
                <button class="btn-secondary">Add another memory</button>
                <button class="btn-primary" id="btn-invite">Invite your partner</button>
            </div>
        </div>
    </section>

    <!-- INVITE MODAL -->
    <div id="invite-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="title" style="margin-bottom: 8px;">Invite your partner <span
                    style="font-size: 0.6em; opacity: 0.5; vertical-align: middle; margin-left: 8px; border: 1px solid #ccc; border-radius: 4px; padding: 2px 6px;">PREVIEW</span>
            </h2>
            <p class="subtitle" style="margin-bottom: 24px;">Keepsy is private. Your partner will verify via OTP.</p>

            <div class="input-group" style="text-align: left; margin-bottom: 16px;">
                <label style="display: block; font-size: 14px; margin-bottom: 6px; font-weight: 600;">Partner's
                    Email</label>
                <input type="email" id="partner-email" placeholder="hello@example.com"
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
            </div>

            <div class="input-group" style="text-align: left; margin-bottom: 24px;">
                <label style="display: block; font-size: 14px; margin-bottom: 6px; font-weight: 600;">Partner's
                    Phone</label>
                <input type="tel" id="partner-phone" placeholder="+1234567890"
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
            </div>

            <p id="invite-validation-msg" style="color: #d9534f; font-size: 14px; margin-bottom: 16px; display: none;">
                Add at least one way to verify your partner.
            </p>

            <div class="invite-link-wrapper">
                <span class="invite-link" style="color: #888;">.../invite.html</span>
                <button id="btn-copy" class="btn-copy">Copy link</button>
            </div>

            <p class="trust-copy" style="text-align: left; margin-bottom: 32px; margin-top: 12px;">
                <strong>Security Note:</strong> This link is currently a placeholder. Start the backend to enable secure
                invite generation.
            </p>

            <button id="btn-close-modal" class="btn-secondary"
                style="margin: 0 auto; display: inline-block; width: auto; padding: 10px 30px;">Done</button>
        </div>
    </div>

    <script>
        // DOM Elements
        const screenStart = document.getElementById('screen-start');
        const screenMemory = document.getElementById('screen-memory');
        const screenTimeline = document.getElementById('screen-timeline');

        const startForm = document.getElementById('start-form');
        const memoryForm = document.getElementById('memory-form');

        const photoInput = document.getElementById('memory-photo');
        const imagePreview = document.getElementById('image-preview');
        const fileText = document.getElementById('file-text');

        // State
        let state = {
            startDate: null,
            memoryDate: new Date().toISOString().split('T')[0], // Default to today
            photoSrc: null,
            note: ''
        };

        // Initialize
        document.getElementById('memory-date').value = state.memoryDate;

        // Transitions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // Handler: Start Form
        startForm.addEventListener('submit', (e) => {
            e.preventDefault();
            state.startDate = document.getElementById('start-date').value;
            showScreen('screen-memory');
        });

        // Handler: Photo Preview
        photoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.photoSrc = e.target.result;
                    imagePreview.style.backgroundImage = `url(${state.photoSrc})`;
                    imagePreview.classList.remove('hidden');
                    fileText.textContent = "Change photo";
                };
                reader.readAsDataURL(file);
            }
        });

        // Handler: Memory Form
        memoryForm.addEventListener('submit', (e) => {
            e.preventDefault();
            state.memoryDate = document.getElementById('memory-date').value;
            state.note = document.getElementById('memory-note').value;
            renderTimeline();
            showScreen('screen-timeline');
        });

        // Render Timeline
        function renderTimeline() {
            // Days calculation
            const start = new Date(state.startDate);
            const today = new Date();
            const diffTime = Math.abs(today - start);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('days-count').textContent = diffDays;

            // Content
            document.getElementById('display-photo').src = state.photoSrc;

            // Format Date
            const dateObj = new Date(state.memoryDate);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('display-date').textContent = dateObj.toLocaleDateString(undefined, options);

            const noteDisplay = document.getElementById('display-note');
            if (!state.note || !state.note.trim()) {
                noteDisplay.style.display = 'none';
            } else {
                noteDisplay.style.display = 'block';
                noteDisplay.textContent = state.note;
            }
        }

        // Invite Modal Logic
        const modal = document.getElementById('invite-modal');
        const btnInvite = document.getElementById('btn-invite');
        const btnCloseModal = document.getElementById('btn-close-modal');
        const btnCopy = document.getElementById('btn-copy');

        if (btnInvite) {
            btnInvite.addEventListener('click', () => {
                modal.classList.add('active');
            });
        }

        if (btnCloseModal) {
            btnCloseModal.addEventListener('click', () => {
                modal.classList.remove('active');
                setTimeout(() => {
                    btnCopy.textContent = "Copy link"; // Reset copy text
                }, 300);
            });
        }

        if (btnCopy) {
            btnCopy.addEventListener('click', async () => {
                const email = document.getElementById('partner-email').value.trim();
                const phone = document.getElementById('partner-phone').value.trim();
                const validationMsg = document.getElementById('invite-validation-msg');

                // Validation
                if (!email && !phone) {
                    validationMsg.style.display = 'block';
                    return;
                }
                validationMsg.style.display = 'none';

                // Call Backend
                btnCopy.textContent = "Generating...";
                btnCopy.disabled = true;

                try {
                    const response = await fetch('http://localhost:3000/api/invite', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, phone }) // keepsyId omitted for MVP default
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to generate link');
                    }

                    // Copy Link
                    await navigator.clipboard.writeText(data.inviteLink);

                    btnCopy.textContent = "Copied";
                    setTimeout(() => {
                        btnCopy.textContent = "Copy link";
                        btnCopy.disabled = false;
                    }, 2000);

                } catch (err) {
                    console.error("Invite Error:", err);
                    btnCopy.textContent = "Error";
                    alert("Could not generate invite: " + err.message);
                    setTimeout(() => {
                        btnCopy.textContent = "Copy link";
                        btnCopy.disabled = false;
                    }, 3000);
                }
            });
        }
    </script>
</body>

</html>